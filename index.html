<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title> veriblock nodecore-js [dev]</title>

    <link rel="stylesheet" href="./html/js/codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="./html/js/codemirror/theme/eclipse.css">
    <link rel="stylesheet" href="./html/js/codemirror/theme/base16-dark.css">

    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css"> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.7.0/css/all.css' integrity='sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ' crossorigin='anonymous'>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <script src="./html/js/codemirror/lib/codemirror.js"></script>
    <script src="./html/js/codemirror/mode/javascript/javascript.js"></script>

    <script src="./html/dist/bundle.dev.js"></script>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      #uiform {
        height: 70%;
        width: 100%;
        overflow: scroll;
      }
      #console {
        height: 30%;
        width: 100%;
      }
      #console-container  {
        height: 30%;
        width: 100%;
      }
      #scroll-window {
       height: 30%;
       width: 100%;
       overflow: scroll;
     }
      #button {
        vertical-align: bottom;
      }
      .data-box {
        width: 300px;
      }
      .generated{
        background: #eeefff;
      }
      .generated-sign{
        background: #ffefee;
      }
      .marked{
        background: #ffaaaa;
      }
      .code-box {
        border-style: dotted;
        border-width: 2px;
      }
      .code {
        background: #ffddcc
      }
    </style>
  </head>
  <body>

    <h2 style="text-align:center">test page for nodecore-js <a href="https://github.com/VeriBlock/nodecore-js">git repo</a></h2>


      <div class="">
        <ul style="display:table; margin:0 auto;">
          <li>all functions and feauters are available via browser console <u class="code">#:> VeriBlock.*</u></li>
        </ul>
      </div>


    <div class="form-group">
      <div class="col-sm-offset-2 col-sm-10">
        <button id="btn-isValidAddr" class="btn btn-outline-secondary">isValidStandardAddress</button>
        <button id="btn-addrFromPubKey" class="btn btn-outline-secondary">addrFromPublicKey</button>
        <button id="btn-signMessage" class="btn btn-outline-secondary">signMessageWithPrivateKey</button>
        <button id="btn-generateKeypair" class="btn btn-outline-secondary">generateKeypair</button>
      </div>
    </div>

    <div class="col-sm-offset-2 col-sm-10">
        <button class="btn btn-outline-secondary" type="button" id="button-example"><i class="fab fa-angellist"></i></button> - press to get <b>default property value</b>
    </div>
    <p>

    <div class="form-group input-group">
      <div class="input-group-prepend">
        <span class="input-group-text">address:</span>
      </div>
      <input type="text" class="form-control generated" id="address" name="address" alt="1234">
      <div class="input-group-append">
        <button class="btn btn-outline-secondary" type="button" id="button-addr-def"><i class="fab fa-angellist"></i></button>
      </div>
    </div>


    <div class="form-group input-group">
      <div class="input-group-prepend">
        <span class="input-group-text for-btn-verify-sign for-btn-gen-addr" for="pubKey">public key [B64]:</span>
      </div>
      <input type="text" class="form-control generated" id="pubKey" name="pubKey">
      <div class="input-group-append">
        <button class="btn btn-outline-secondary" type="button" id="button-pubKey-def"><i class="fab fa-angellist"></i></button>
      </div>
    </div>

    <div class="form-group input-group">
      <div class="input-group-prepend">
        <span class="input-group-text for-btn-verify-sign for-btn-gen-addr" for="privKey">private key [B64]:</span>
      </div>
      <input type="text" class="form-control generated" id="privKey" name="privkey">
      <div class="input-group-append">
        <button class="btn btn-outline-secondary" type="button" id="button-privKey-def"><i class="fab fa-angellist"></i></button>
      </div>
    </div>

    <div class="form-group input-group">
      <div class="input-group-prepend">
        <span class="input-group-text for-btn-verify-sign for-btn-gen-addr" for="sigIndex">Signature Index (number):</span>
      </div>
      <input type="text" class="form-control generated" id="sigIndex" name="sigIndex" value="0">
    </div>

    <div class="form-group input-group">
      <div class="input-group-prepend">
        <span class="input-group-text for" for="validAddr">Is address valid?</span>
      </div>
      <input type="text" class="form-control generated-sign" id="validAddr" name="validAddr" disabled>

      <div class="input-group-append">
      </div>
    </div>

    <div class="col-sm-offset-2 col-sm-10">
        <b>message</b> for signing:
    </div>
    <p>
    <div class="form-group input-group">
      <textarea class="form-control generated-sign" aria-label="With textarea" id="message"></textarea>
      <div class="input-group-append">
      </div>
    </div>

    <div class="col-sm-offset-2 col-sm-10">
        <b>signature HEX bytes[]</b>:
    </div>
    <p>
    <div class="form-group input-group">
      <textarea class="form-control generated-sign" aria-label="With textarea" id="signature" disabled></textarea>
      <div class="input-group-append">
      </div>
    </div>

    <div class="col-sm-offset-2 col-sm-10">
        <b>Transaction</b>:
    </div>
    <div class="form-group">
      <div class="col-sm-offset-2 col-sm-10">
        <button id="btn-tx-createBlankTx" class="btn btn-outline-secondary">blankTx</button>
        <button id="btn-tx-createRawTx"   class="btn btn-outline-secondary">createRawTx</button>
        <!-- <button id="btn-tx-substitute" class="btn btn-outline-secondary">Substitute</button> -->
        <!-- <button id="btn-tx-calcTxID"      class="btn btn-outline-secondary">TxID</button> -->
        <button id="btn-tx-sign"          class="btn btn-outline-secondary">signTx</button>
        <button id="btn-tx-serizalizeTx"  class="btn btn-outline-secondary" disabled>Serialize</button>
        <button id="btn-tx-plusOut"       class="btn btn-outline-secondary">+ Out</button>
        <button id="btn-tx-minusOut"      class="btn btn-outline-secondary">- Out</button>
      </div>
    </div>
    <div class="col-sm-offset-2 col-sm-10">
        <b>serialization bytes[] for TxID</b>:
    </div>
    <p>
    <div class="form-group input-group">
      <textarea class="form-control generated-sign" aria-label="With textarea" id="txSerialization" disabled></textarea>
      <div class="input-group-append">
        <!-- <button class="btn btn-outline-secondary" type="button"><i class='fas fa-backspace'></i></button>
        <button class="btn btn-outline-secondary" type="button"><i class='far fa-copy'></i></button>
        <button class="btn btn-outline-secondary" type="button"><i class='fa fa-paste'></i></button> -->
      </div>
    </div>
    <div class="code-box" >
      <textarea id="code-data" >

      </textarea>
    </div>

    <script>

    var data = {
      set address(value) {
        $("#address").val(value);
      },
      get address() {
        return $("#address").val();
      },

      set pubKey64(value) {
        $("#pubKey").val(value);
      },
      get pubKey64() {
        return $("#pubKey").val();
      },

      set privKey64(value) {
        $("#privKey").val(value);
      },
      get privKey64() {
        return $("#privKey").val();
      },

      set message(value) {
        $("#message").val(value);
      },
      get message() {
        return $("#message").val();
      },

      set signature(value) {
        $("#signature").val(value);
      },
      get signature() {
        return $("#signature").val();
      },

      set signatureIndex(value) {
        $("#sigIndex").val(value);
      },
      get signatureIndex() {
        return $("#sigIndex").val();
      },

      set transaction(value) {
        $("#code-data").val(value);
      },
      get transaction() {
        return $("#code-data").val();
      }
    };

      var mta = document.getElementById("code-data");
      var myCodeMirror = CodeMirror(function(elt) {
        mta.parentNode.replaceChild(elt, mta);
      }, {
        // value: NodecoreJS.lib.JsonPretty(tx, {maxLength: 200}),
      });

      var example = {
        addresses : ["V44i36pPHyhaiW695Xg8PEos4G2PrC", "V6dYV2P3sd8ALsgyrnDc7QToW7unHA"],
        pubKeys   : [
          "MFYwEAYHKoZIzj0CAQYFK4EEAAoDQgAERma1mS2caMSQHp4fV/UbRipyQCu47VOik8oQze9SA3EMxuLWlTHBBEYWALFBTxpcd99ksgWaOmGxAdfJ9Ybctg==",
          "MFYwEAYHKoZIzj0CAQYFK4EEAAoDQgAE1FUzpjM/Dv8gLfOND6GxuJXPHDPIDWPp0C0ju6DyiTCCVGKyb3KrVpP+o1RPyXqSlD8YxMk9qadeuCPgGkvtlA=="
        ],
        privKey   : [
          "MFYwEAYHKoZIzj0CAQYFK4EEAAoDQgAE1FUzpjM/Dv8gLfOND6GxuJXPHDPIDWPp0C0ju6DyiTCCVGKyb3KrVpP+o1RPyXqSlD8YxMk9qadeuCPgGkvtlA==",
          "MD4CAQAwEAYHKoZIzj0CAQYFK4EEAAoEJzAlAgEBBCB0TYqZAfRD2u/LZhJBqTV8Dg9+VfOc8gmh2K50QmmT4w=="
        ]
      };

      var exampleAddr    = "V44i36pPHyhaiW695Xg8PEos4G2PrC";
      var examplePubKey  = "MFYwEAYHKoZIzj0CAQYFK4EEAAoDQgAERma1mS2caMSQHp4fV/UbRipyQCu47VOik8oQze9SA3EMxuLWlTHBBEYWALFBTxpcd99ksgWaOmGxAdfJ9Ybctg==";
      var examplePrivKey = "MD4CAQAwEAYHKoZIzj0CAQYFK4EEAAoEJzAlAgEBBCCV0ZmUM1F3hTwbX47m0lDD+Al3j+y2TDMHNq076EPCzQ==";


      $('#button-addr-def').on('click', function(){
        data.address = exampleAddr;
      });

      $('#button-pubKey-def').on('click', function(){
        data.pubKey64 = examplePubKey;
      });

      $('#button-privKey-def').on('click', function(){
        data.privKey64 = examplePrivKey;
      });

      $('#button-example').on('click', function(){
        data.address   = exampleAddr;
        data.pubKey64  = examplePubKey;
        data.privKey64 = examplePrivKey;
        data.message   = "hello world"
      });

      $('#btn-generateKeypair').on('click', function(){
        let r = VeriBlock.crypto.KeyPair.generate();
        data.privKey64 = r.privateKey.asn1.toString('base64');
        data.pubKey64 = r.publicKey.asn1.toString('base64');
        data.address = r.publicKey.getAddress()
      });

      $('#btn-isValidAddr').on('click', function(){
        let r = VeriBlock.address.isValidStandardAddress(data.address);
        $('#validAddr').val(r);
      });

      $('#btn-addrFromPubKey').on('click', function(){
        const pub = VeriBlock.crypto.PublicKey.fromStringBase64(data.pubKey64);
        data.address = VeriBlock.address.addressFromPublicKey(pub);
      });

      $('#btn-signMessage').on('click', function(){
        try {
          var msg = VeriBlock.util.bufferFromUtf8(data.message);
          var pk = VeriBlock.crypto.PrivateKey.fromStringBase64(data.privKey64);
          var signature = VeriBlock.crypto.SHA256withECDSA.sign(msg, pk)
          // var message = data.message;
          // var pk = VeriBlock.crypto.PrivateKey.fromStringBase64(data.privKey64);
          // var tx = VeriBlock.transaction.Transaction.parse(data.transaction);
          // var kp = VeriBlock.crypto.KeyPair.fromPrivateKey(pk);
          // var signature = VeriBlock.transaction.signTransaction(tx, kp, data.signatureIndex);
          data.signature = signature.toStringHex(); //signature.asn1.toString('base64');
        } catch(e) {
          alert(`Invalid signature: ${JSON.stringify(e)}`);
        }
      });

      // Transaction operations
      $('#btn-tx-createBlankTx').on('click', function(){
        var tx = VeriBlock.transaction.Transaction(
                data.address,
                100,

        )
        tx.address = data.address;

        tx2pretty(tx);
      });

      $('#btn-tx-createRawTx').on('click', function(){
        txLoad();

        tx = NodecoreJS.transaction.createRawTx(tx);

        tx2pretty(tx);
      });

      $('#btn-tx-sign').on('click', function(){
        txLoad();
        var privKey   = NodecoreJS.tools.codecs.base64_to_hex(data.privKey64);
        tx = NodecoreJS.transaction.signTx(tx, privKey);
        //var signature = NodecoreJS.unit.Utility.signMessageWithPrivateKey(tx.id, data.privKey64);
        //tx.signature = signature;
        tx2pretty(tx);
      });

      $('#btn-tx-serizalizeTx').on('click', function(){
        txLoad();
        var serialized = NodecoreJS.lib.JsonPretty(Array.from(tx.TxSerializeByteArray()), {maxLength :2000})
        $('#txSerialization').val(serialized)
      });

      $('#btn-tx-plusOut').on('click', function(){
        txLoad();
        tx.outputs.push({"address": data.address, "amount": 0});
        tx2pretty(tx);
      });

      $('#btn-tx-minusOut').on('click', function(){
        txLoad();
        tx.outputs = tx.outputs.slice(0,-1);
        tx2pretty(tx);
      });

      function txLoad(){
        tx = Object.assign(tx, JSON.parse(myCodeMirror.getValue()));
        //tx.id = Uint8Array.from(tx.id);
        tx.data = Uint8Array.from(tx.data)
        //tx.signature = Uint8Array.from(tx.signature);
      }

      function tx2pretty(tx){
        var outJson = {...tx};
        //outJson.id = Array.from(outJson.id);
        outJson.data = Array.from(outJson.data)
        //outJson.signature = Array.from(outJson.signature)

        var text = NodecoreJS.lib.JsonPretty(outJson, {maxLength: 160});
        myCodeMirror.setValue(text);
      }


    </script>


    <h2 style="text-align:center">any <a href="https://github.com/VeriBlock/nodecore-js/issues">ideas</a> for improvements?</h2>
  </body>
</html>
